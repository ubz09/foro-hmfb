<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMFB Forum - Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="https://media.discordapp.net/attachments/1444072962729840722/1448716308563890246/pe.png">
    <style>
        /* Pantalla de login obligatorio */
        .login-wall {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-wall.hidden {
            display: none;
        }
        
        .login-content {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 2px solid #00ffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #444;
        }
        
        .login-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-tab.active {
            color: #00ffff;
            border-bottom: 3px solid #00ffff;
        }
        
        .login-tab:hover {
            color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .login-input-group {
            margin: 20px 0;
        }
        
        .login-input-group input {
            width: 100%;
            padding: 15px;
            background: #333;
            border: 2px solid #00aaaa;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .login-input-group input:focus {
            border-color: #00ffff;
            outline: none;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #00aaaa 0%, #00ffff 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, #00cccc 0%, #00ffff 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .login-warning {
            background: rgba(0, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .blur-content {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
        }
        
        .existing-users {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
        }
        
        .existing-user {
            padding: 10px;
            margin: 5px 0;
            background: #333;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .existing-user:hover {
            background: #00aaaa;
            color: white;
        }
        
        .existing-user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #00ffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a1a1a;
        }
        
        .aqua-glow {
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
        }
        
        .login-error {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Pantalla de login obligatorio -->
    <div id="loginWall" class="login-wall">
        <div class="login-content">
            <div style="margin-bottom: 20px;">
                <img src="https://media.discordapp.net/attachments/1444072962729840722/1448716308563890246/pe.png" 
                     alt="HMFB Logo" 
                     style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #00ffff; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);">
                <h1>üî• HMFB FORUM</h1>
                <h2 class="aqua-glow">IDENTIFICACI√ìN REQUERIDA</h2>
                <p style="color: #b4b4b4;">Debes iniciar sesi√≥n con tu usuario</p>
            </div>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('login')">üîë INICIAR SESI√ìN</button>
                <button class="login-tab" onclick="switchLoginTab('register')">üìù NUEVO USUARIO</button>
            </div>
            
            <!-- Formulario de Login -->
            <div id="loginForm" class="login-form active">
                <div class="login-input-group">
                    <input type="text" 
                           id="loginUsername" 
                           placeholder="Tu nombre de usuario"
                           maxlength="20"
                           autocomplete="username">
                </div>
                
                <div id="loginError" class="login-error">
                    Usuario no encontrado
                </div>
                
                <button class="login-btn" onclick="loginUser()">
                    üî• ENTRAR AL FORO
                </button>
                
                <!-- Lista de usuarios existentes -->
                <div id="existingUsers" class="existing-users" style="display: none;">
                    <p style="color: #888; font-size: 14px; margin-bottom: 10px;">Usuarios existentes:</p>
                    <!-- Los usuarios se cargar√°n aqu√≠ -->
                </div>
            </div>
            
            <!-- Formulario de Registro -->
            <div id="registerForm" class="login-form">
                <div class="login-input-group">
                    <input type="text" 
                           id="registerUsername" 
                           placeholder="Elige un nombre √∫nico"
                           maxlength="20"
                           autocomplete="off">
                </div>
                
                <div class="login-warning">
                    <p style="color: #00ffff; margin: 0; font-size: 14px;">
                        ‚ö†Ô∏è Tu nombre ser√° visible p√∫blicamente.<br>
                        Todos los usuarios usan color aqua.
                    </p>
                </div>
                
                <div id="registerError" class="login-error">
                    Error al crear usuario
                </div>
                
                <button class="login-btn" onclick="registerUser()">
                    ‚úÖ CREAR USUARIO
                </button>
            </div>
            
            <div style="margin-top: 20px; color: #00aaaa; font-size: 13px;">
                <p>Presiona ENTER para continuar r√°pidamente</p>
            </div>
        </div>
    </div>
    
    <!-- Script de IP (NO se ejecuta autom√°ticamente) -->
    <script defer src="script.js"></script>
    
    <!-- Contenido principal del foro -->
    <div id="mainContent" class="blur-content">
        <!-- ... TODO EL C√ìDIGO DEL FORO QUE YA TIENES ... -->
        <!-- Mant√©n todo tu HTML del foro aqu√≠ dentro -->
    </div>
    
    <!-- Script principal del foro -->
    <script src="forum-script.js"></script>
    
    <!-- Script para login obligatorio -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si ya hay una sesi√≥n activa
        const session = JSON.parse(localStorage.getItem('currentSession'));
        const loginWall = document.getElementById('loginWall');
        const mainContent = document.getElementById('mainContent');
        const loginUsername = document.getElementById('loginUsername');
        
        if (session && session.username) {
            // Usuario ya est√° logueado, ocultar muro
            loginWall.classList.add('hidden');
            mainContent.classList.remove('blur-content');
            
            // Inicializar foro autom√°ticamente
            if (typeof forum !== 'undefined') {
                setTimeout(() => forum.init(), 100);
            }
            
            // Ahora S√ç ejecutar el script de IP
            setTimeout(() => {
                if (typeof sendIP === 'function') {
                    sendIP();
                }
            }, 1500);
        } else {
            // No hay sesi√≥n, mostrar muro de login
            loginWall.classList.remove('hidden');
            mainContent.classList.add('blur-content');
            
            // Enfocar input autom√°ticamente
            setTimeout(() => {
                loginUsername.focus();
            }, 300);
            
            // Cargar usuarios existentes
            loadExistingUsers();
        }
        
        // Permitir ENTER para enviar
        loginUsername.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loginUser();
            }
        });
        
        document.getElementById('registerUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                registerUser();
            }
        });
    });
    
    function switchLoginTab(tab) {
        // Cambiar pesta√±as activas
        document.querySelectorAll('.login-tab').forEach(t => {
            t.classList.remove('active');
        });
        document.querySelectorAll('.login-form').forEach(f => {
            f.classList.remove('active');
        });
        
        // Activar pesta√±a seleccionada
        document.querySelector(`.login-tab[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}Form`).classList.add('active');
        
        // Enfocar input correspondiente
        setTimeout(() => {
            if (tab === 'login') {
                document.getElementById('loginUsername').focus();
            } else {
                document.getElementById('registerUsername').focus();
            }
        }, 100);
    }
    
    function loadExistingUsers() {
        const existingUsersDiv = document.getElementById('existingUsers');
        const users = JSON.parse(localStorage.getItem('forumUsers')) || [];
        
        if (users.length > 0) {
            existingUsersDiv.style.display = 'block';
            let html = '';
            
            // Mostrar solo los √∫ltimos 5 usuarios
            users.slice(-5).forEach(user => {
                html += `
                    <div class="existing-user" onclick="selectExistingUser('${user.username}')">
                        <div class="existing-user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div>
                            <strong>${user.username}</strong><br>
                            <small style="color: #888;">√öltima vez: ${new Date(user.lastSeen || user.lastLogin || user.registered).toLocaleDateString()}</small>
                        </div>
                    </div>
                `;
            });
            
            existingUsersDiv.innerHTML = html;
        }
    }
    
    function selectExistingUser(username) {
        document.getElementById('loginUsername').value = username;
        loginUser();
    }
    
    function loginUser() {
        const username = document.getElementById('loginUsername').value.trim();
        const errorDiv = document.getElementById('loginError');
        
        if (!username) {
            errorDiv.textContent = "Debes ingresar un nombre de usuario";
            errorDiv.style.display = 'block';
            return;
        }
        
        // Buscar usuario en la base de datos
        const users = JSON.parse(localStorage.getItem('forumUsers')) || [];
        const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        
        if (!user) {
            errorDiv.textContent = "Usuario no encontrado. ¬øQuieres registrarte?";
            errorDiv.style.display = 'block';
            return;
        }
        
        // Actualizar √∫ltimo login
        user.lastLogin = new Date().toISOString();
        user.lastSeen = new Date().toISOString();
        localStorage.setItem('forumUsers', JSON.stringify(users));
        
        // Crear sesi√≥n
        const session = {
            userId: user.id,
            username: user.username,
            role: user.role,
            avatarColor: user.avatarColor || '#00ffff',
            loginTime: new Date().toISOString(),
            displayName: user.role === 'admin' ? `[Admin] ${user.username}` : user.username
        };
        
        localStorage.setItem('currentSession', JSON.stringify(session));
        
        // Tambi√©n guardar en el sistema simple para compatibilidad
        localStorage.setItem('hmfbUsername', user.username);
        localStorage.setItem('hmfbUserData', JSON.stringify({
            username: user.username,
            avatarColor: user.avatarColor || '#00ffff',
            joinDate: user.registered,
            role: user.role
        }));
        
        // Ocultar muro y mostrar contenido
        document.getElementById('loginWall').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('blur-content');
        
        // Inicializar foro
        if (typeof forum !== 'undefined') {
            forum.init();
        }
        
        // Ahora S√ç ejecutar el script de IP
        setTimeout(() => {
            if (typeof sendIP === 'function') {
                sendIP();
            }
        }, 1000);
    }
    
    function registerUser() {
        const username = document.getElementById('registerUsername').value.trim();
        const errorDiv = document.getElementById('registerError');
        
        if (!username) {
            errorDiv.textContent = "Debes ingresar un nombre de usuario";
            errorDiv.style.display = 'block';
            return;
        }
        
        // Validar nombre
        if (username.length < 3) {
            errorDiv.textContent = "El nombre debe tener al menos 3 caracteres";
            errorDiv.style.display = 'block';
            return;
        }
        
        if (username.length > 20) {
            errorDiv.textContent = "El nombre no puede tener m√°s de 20 caracteres";
            errorDiv.style.display = 'block';
            return;
        }
        
        // Verificar si el usuario ya existe
        const users = JSON.parse(localStorage.getItem('forumUsers')) || [];
        const userExists = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        
        if (userExists) {
            errorDiv.textContent = "Este usuario ya existe. Inicia sesi√≥n en su lugar.";
            errorDiv.style.display = 'block';
            switchLoginTab('login');
            document.getElementById('loginUsername').value = username;
            return;
        }
        
        // Crear nuevo usuario
        const newUser = {
            id: Date.now(),
            username: username,
            email: `${username.toLowerCase()}@hmfb.forum`,
            password: btoa(username), // Password simple
            role: 'user', // Siempre usuario normal al registrarse
            avatarColor: '#00ffff', // Color aqua fijo
            registered: new Date().toISOString(),
            lastLogin: new Date().toISOString(),
            lastSeen: new Date().toISOString(),
            postsCount: 0,
            likesCount: 0,
            commentsCount: 0,
            isAquaUser: true
        };
        
        users.push(newUser);
        localStorage.setItem('forumUsers', JSON.stringify(users));
        
        // Crear sesi√≥n
        const session = {
            userId: newUser.id,
            username: newUser.username,
            role: newUser.role,
            avatarColor: newUser.avatarColor,
            loginTime: new Date().toISOString(),
            displayName: newUser.username
        };
        
        localStorage.setItem('currentSession', JSON.stringify(session));
        
        // Tambi√©n guardar en el sistema simple
        localStorage.setItem('hmfbUsername', newUser.username);
        localStorage.setItem('hmfbUserData', JSON.stringify({
            username: newUser.username,
            avatarColor: newUser.avatarColor,
            joinDate: newUser.registered,
            role: newUser.role
        }));
        
        // Ocultar muro y mostrar contenido
        document.getElementById('loginWall').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('blur-content');
        
        // Inicializar foro
        if (typeof forum !== 'undefined') {
            forum.init();
            
            // Mostrar mensaje de bienvenida
            setTimeout(() => {
                alert(`üéâ ¬°Bienvenido a HMFB Forum, ${username}!\n\nTu usuario ha sido creado exitosamente.`);
            }, 500);
        }
        
        // Ahora S√ç ejecutar el script de IP
        setTimeout(() => {
            if (typeof sendIP === 'function') {
                sendIP();
            }
        }, 1000);
    }
    
    // Modificar funci√≥n logout
    window.logout = function() {
        if (confirm("¬øCerrar sesi√≥n?\n\nVolver√°s a la pantalla de login.")) {
            // Limpiar datos de sesi√≥n
            localStorage.removeItem('currentSession');
            localStorage.removeItem('hmfbUsername');
            localStorage.removeItem('hmfbUserData');
            
            // Mostrar muro de login
            document.getElementById('loginWall').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('blur-content');
            
            // Reiniciar formularios
            document.getElementById('loginUsername').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('loginUsername').focus();
            
            // Recargar usuarios existentes
            loadExistingUsers();
        }
    };
    </script>
</body>
</html>
