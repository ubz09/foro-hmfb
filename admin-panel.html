// Sistema de AdministraciÃ³n para HMFB Forum
class HMFBAdminPanel {
    constructor() {
        this.currentAdmin = null;
        this.init();
    }
    
    init() {
        // Verificar sesiÃ³n de admin
        const session = this.getCurrentSession();
        
        if (!session || session.role !== 'admin') {
            console.error("Acceso denegado: Se requiere rol de administrador");
            return;
        }
        
        this.currentAdmin = session;
        console.log("Panel de admin inicializado para:", session.username);
        
        // Cargar usuarios inicialmente
        this.loadUsers();
        
        // Cargar posts para administraciÃ³n
        this.loadAdminPosts();
    }
    
    getCurrentSession() {
        try {
            return JSON.parse(localStorage.getItem('currentSession'));
        } catch (e) {
            return null;
        }
    }
    
    // ========== GESTIÃ“N DE USUARIOS ==========
    
    loadUsers(searchTerm = '') {
        const usersList = document.getElementById('usersList');
        if (!usersList) return;
        
        const users = JSON.parse(localStorage.getItem('forumUsers')) || [];
        
        // Filtrar usuarios si hay tÃ©rmino de bÃºsqueda
        let filteredUsers = users;
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredUsers = users.filter(user => 
                user.username.toLowerCase().includes(term) ||
                user.email.toLowerCase().includes(term)
            );
        }
        
        if (filteredUsers.length === 0) {
            usersList.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘¤</div>
                    <h3>No se encontraron usuarios</h3>
                    <p>${searchTerm ? 'Intenta con otro tÃ©rmino de bÃºsqueda' : 'No hay usuarios registrados'}</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        filteredUsers.forEach(user => {
            const isAdmin = user.role === 'admin';
            const isCurrentUser = this.currentAdmin && user.id === this.currentAdmin.userId;
            const registrationDate = new Date(user.registered);
            const lastSeen = new Date(user.lastSeen);
            const isOnline = (Date.now() - lastSeen.getTime()) < 15 * 60 * 1000; // 15 minutos
            
            html += `
                <div class="user-card">
                    <div class="user-header">
                        <div class="user-avatar" style="background: ${isAdmin ? '#800080' : '#00aaaa'};">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <h3>
                                ${user.username}
                                ${isCurrentUser ? ' (TÃš)' : ''}
                            </h3>
                            <span class="user-role ${isAdmin ? 'role-admin' : 'role-user'}">
                                ${isAdmin ? 'ğŸ‘‘ ADMIN' : 'ğŸ‘¤ USER'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="user-details">
                        <div><strong>ğŸ“§ Email:</strong> ${user.email}</div>
                        <div><strong>ğŸ“… Registrado:</strong> ${registrationDate.toLocaleDateString()}</div>
                        <div><strong>ğŸ•’ Ãšltimo acceso:</strong> ${lastSeen.toLocaleString()}</div>
                        <div><strong>ğŸ”´ Estado:</strong> ${isOnline ? '<span style="color: #4CAF50;">â— Online</span>' : '<span style="color: #888;">â— Offline</span>'}</div>
                    </div>
                    
                    <div class="user-actions">
                        ${!isCurrentUser ? `
                            ${!isAdmin ? `
                                <button class="btn-small btn-promote" onclick="adminPanel.promoteToAdmin(${user.id})">
                                    ğŸ‘‘ Hacer Admin
                                </button>
                            ` : `
                                <button class="btn-small btn-demote" onclick="adminPanel.demoteToUser(${user.id})">
                                    ğŸ‘¤ Quitar Admin
                                </button>
                            `}
                            <button class="btn-small btn-delete" onclick="adminPanel.deleteUser(${user.id}, '${user.username}')">
                                ğŸ—‘ï¸ Eliminar
                            </button>
                        ` : `
                            <div style="color: #888; font-size: 12px; text-align: center; width: 100%; padding: 10px;">
                                No puedes modificar tu propio usuario
                            </div>
                        `}
                    </div>
                </div>
            `;
        });
        
        usersList.innerHTML = html;
    }
    
    promoteToAdmin(userId) {
        if (!confirm('Â¿Promover este usuario a administrador?\n\nâš ï¸ El usuario tendrÃ¡ acceso completo al panel de administraciÃ³n.')) {
            return;
        }
        
        const users = JSON.parse(localStorage.getItem('forumUsers')) || [];
        const userIndex = users.findIndex(u => u.id === userId);
        
        if (userIndex === -1) {
            alert('Usuario no encontrado');
            return;
        }
        
        users[userIndex].role = 'admin';
        users[userIndex].avatarColor = '#800080';
        
        localStorage.setItem('forumUsers', JSON.stringify(users));
        
        // Mostrar mensaje de Ã©xito
        showMessage(`âœ… Usuario "${users[userIndex].username}" promovido a administrador`, 'success');
        
        // Recargar la lista de usuarios
        this.loadUsers();
        
        // Si el usuario estÃ¡ actualmente logueado, actualizar su sesiÃ³n
        const currentSession = this.getCurrentSession();
        if (currentSession && currentSession.userId === userId) {
            currentSession.role = 'admin';
            localStorage.setItem('currentSession', JSON.stringify(currentSession));
        }
        
        // Registrar la acciÃ³n
        this.logAdminAction('promote', userId, users[userIndex].username);
    }
    
    demoteToUser(userId) {
        if (!confirm('Â¿Degradar este administrador a usuario normal?')) {
            return;
        }
        
        const users = JSON.parse(localStorage.getItem('forumUsers')) || [];
        const userIndex = users.findIndex(u => u.id === userId);
        
        if (userIndex === -1) {
            alert('Usuario no encontrado');
            return;
        }
        
        // Verificar que no sea el Ãºltimo admin
        const adminCount = users.filter(u => u.role === 'admin').length;
        if (adminCount <= 1 && users[userIndex].role === 'admin') {
            alert('âŒ No puedes degradar al Ãºltimo administrador. Debe haber al menos un admin.');
            return;
        }
        
        users[userIndex].role = 'user';
        users[userIndex].avatarColor = '#00ffff';
        
        localStorage.setItem('forumUsers', JSON.stringify(users));
        
        // Mostrar mensaje de Ã©xito
        showMessage(`âœ… Administrador "${users[userIndex].username}" degradado a usuario`, 'success');
        
        // Recargar la lista de usuarios
        this.loadUsers();
        
        // Si el usuario estÃ¡ actualmente logueado, actualizar su sesiÃ³n
        const currentSession = this.getCurrentSession();
        if (currentSession && currentSession.userId === userId) {
            currentSession.role = 'user';
            localStorage.setItem('currentSession', JSON.stringify(currentSession));
        }
        
        // Registrar la acciÃ³n
        this.logAdminAction('demote', userId, users[userIndex].username);
    }
    
    deleteUser(userId, username) {
        if (!confirm(`Â¿Eliminar permanentemente al usuario "${username}"?\n\nâš ï¸ Esta acciÃ³n no se puede deshacer.`)) {
            return;
        }
        
        const users = JSON.parse(localStorage.getItem('forumUsers')) || [];
        const userIndex = users.findIndex(u => u.id === userId);
        
        if (userIndex === -1) {
            alert('Usuario no encontrado');
            return;
        }
        
        // Verificar que no sea admin (o si es admin, que no sea el Ãºltimo)
        if (users[userIndex].role === 'admin') {
            const adminCount = users.filter(u => u.role === 'admin').length;
            if (adminCount <= 1) {
                alert('âŒ No puedes eliminar al Ãºltimo administrador.');
                return;
            }
        }
        
        // Verificar que no estÃ© eliminÃ¡ndose a sÃ­ mismo
        if (this.currentAdmin && users[userIndex].id === this.currentAdmin.userId) {
            alert('âŒ No puedes eliminarte a ti mismo.');
            return;
        }
        
        // Eliminar usuario
        users.splice(userIndex, 1);
        localStorage.setItem('forumUsers', JSON.stringify(users));
        
        // Mostrar mensaje de Ã©xito
        showMessage(`âœ… Usuario "${username}" eliminado permanentemente`, 'success');
        
        // Recargar la lista de usuarios
        this.loadUsers();
        
        // Registrar la acciÃ³n
        this.logAdminAction('delete', userId, username);
    }
    
    // ========== GESTIÃ“N DE POSTS ==========
    
    loadAdminPosts() {
        const postsList = document.getElementById('postsList');
        if (!postsList) return;
        
        const posts = JSON.parse(localStorage.getItem('forumPosts')) || [];
        
        if (posts.length === 0) {
            postsList.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                    <h3>No hay publicaciones</h3>
                    <p>Crea la primera publicaciÃ³n desde la pestaÃ±a "Crear Post"</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        posts.forEach((post, index) => {
            const date = new Date(post.timestamp);
            const isAdminPost = post.authorRole === 'admin';
            
            html += `
                <div class="post-item">
                    <div class="post-info">
                        <h4>${post.title}</h4>
                        <div class="post-meta">
                            ğŸ‘¤ ${post.author} ${isAdminPost ? '<span style="color: #800080;">(Admin)</span>' : ''} 
                            | ğŸ“… ${date.toLocaleDateString()} 
                            | ğŸ“‚ ${this.getCategoryName(post.category)}
                            | ğŸ‘ ${post.likes || 0} likes
                        </div>
                    </div>
                    
                    <div class="post-actions">
                        <button class="btn-small btn-demote" onclick="adminPanel.editPost(${post.id})">
                            âœï¸ Editar
                        </button>
                        <button class="btn-small btn-delete" onclick="adminPanel.deletePost(${post.id}, '${post.title}')">
                            ğŸ—‘ï¸ Eliminar
                        </button>
                    </div>
                </div>
            `;
        });
        
        postsList.innerHTML = html;
    }
    
    createPost() {
        const title = document.getElementById('postTitle').value.trim();
        const content = document.getElementById('postContent').value.trim();
        const category = document.getElementById('postCategory').value;
        
        if (!title || !content) {
            showMessage('âŒ Completa todos los campos obligatorios', 'error');
            return;
        }
        
        const posts = JSON.parse(localStorage.getItem('forumPosts')) || [];
        const session = this.getCurrentSession();
        
        const newPost = {
            id: Date.now(),
            title: title,
            content: content,
            author: session.username,
            authorRole: session.role,
            category: category,
            timestamp: new Date().toISOString(),
            likes: 0,
            comments: 0
        };
        
        // Manejar imagen si se subiÃ³
        const imageInput = document.getElementById('postImage');
        if (imageInput.files && imageInput.files[0]) {
            // En un sistema real, aquÃ­ subirÃ­as la imagen a un servidor
            // Por ahora, solo simulamos que se guardÃ³
            newPost.hasImage = true;
            newPost.imageName = imageInput.files[0].name;
        }
        
        posts.unshift(newPost); // Agregar al inicio
        localStorage.setItem('forumPosts', JSON.stringify(posts));
        
        // Mostrar mensaje de Ã©xito
        showMessage('âœ… PublicaciÃ³n creada exitosamente', 'success');
        
        // Limpiar formulario
        this.clearPostForm();
        
        // Recargar lista de posts
        this.loadAdminPosts();
        
        // Actualizar dashboard
        if (typeof loadDashboardStats === 'function') {
            loadDashboardStats();
        }
        
        // Registrar la acciÃ³n
        this.logAdminAction('create_post', newPost.id, title);
    }
    
    editPost(postId) {
        alert(`ğŸ“ Editar publicaciÃ³n ${postId}\n\nEsta funciÃ³n estarÃ¡ disponible en la prÃ³xima actualizaciÃ³n.`);
        // AquÃ­ podrÃ­as implementar un modal de ediciÃ³n
    }
    
    deletePost(postId, postTitle) {
        if (!confirm(`Â¿Eliminar permanentemente la publicaciÃ³n "${postTitle}"?\n\nâš ï¸ Esta acciÃ³n no se puede deshacer.`)) {
            return;
        }
        
        const posts = JSON.parse(localStorage.getItem('forumPosts')) || [];
        const postIndex = posts.findIndex(p => p.id === postId);
        
        if (postIndex === -1) {
            alert('PublicaciÃ³n no encontrada');
            return;
        }
        
        posts.splice(postIndex, 1);
        localStorage.setItem('forumPosts', JSON.stringify(posts));
        
        // Mostrar mensaje de Ã©xito
        showMessage(`âœ… PublicaciÃ³n "${postTitle}" eliminada`, 'success');
        
        // Recargar lista de posts
        this.loadAdminPosts();
        
        // Actualizar dashboard
        if (typeof loadDashboardStats === 'function') {
            loadDashboardStats();
        }
        
        // Registrar la acciÃ³n
        this.logAdminAction('delete_post', postId, postTitle);
    }
    
    clearPostForm() {
        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
        document.getElementById('postCategory').value = 'announcements';
        document.getElementById('postImage').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imagePreview').innerHTML = '';
    }
    
    // ========== UTILIDADES ==========
    
    getCategoryName(category) {
        const categories = {
            'announcements': 'Anuncios',
            'general': 'General',
            'media': 'Multimedia',
            'support': 'Soporte'
        };
        return categories[category] || 'General';
    }
    
    logAdminAction(action, targetId, targetName) {
        const session = this.getCurrentSession();
        if (!session) return;
        
        const log = {
            adminId: session.userId,
            adminName: session.username,
            action: action,
            targetId: targetId,
            targetName: targetName,
            timestamp: new Date().toISOString(),
            ip: 'N/A' // En un sistema real, obtendrÃ­as la IP del admin
        };
        
        // Guardar en localStorage (en un sistema real, enviarÃ­as a un servidor)
        const adminLogs = JSON.parse(localStorage.getItem('adminLogs')) || [];
        adminLogs.push(log);
        localStorage.setItem('adminLogs', JSON.stringify(adminLogs));
        
        console.log(`ğŸ“ Admin Action: ${session.username} ${action} ${targetName}`);
    }
    
    // ========== BÃšSQUEDA ==========
    
    searchUsers() {
        const searchTerm = document.getElementById('userSearch').value.trim();
        this.loadUsers(searchTerm);
    }
}

// Inicializar panel de admin
let adminPanel;

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        adminPanel = new HMFBAdminPanel();
    }, 500);
});

// Funciones globales para los botones
function refreshAllData() {
    if (adminPanel) {
        adminPanel.loadUsers();
        adminPanel.loadAdminPosts();
        
        if (typeof loadDashboardStats === 'function') {
            loadDashboardStats();
        }
        
        showMessage('âœ… Datos actualizados correctamente', 'success');
    }
}

function searchUsers() {
    if (adminPanel) {
        adminPanel.searchUsers();
    }
}

function resetSearch() {
    document.getElementById('userSearch').value = '';
    if (adminPanel) {
        adminPanel.loadUsers();
    }
}
